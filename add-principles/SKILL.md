---
name: add-principles
description: 向项目 AGENTS.md 添加通用原则的交互式 Skill。自动检测项目状态、智能去重、计划预览、安全备份。
triggers:
  - 添加原则
  - 增加规范
  - 给项目加原则
  - 同步原则
---

# add-principles Skill

向项目 AGENTS.md 添加通用原则的交互式工具。

## 触发词

- "添加原则"
- "增加规范"
- "给项目加原则"
- "同步原则"

## 执行流程

### Step 1: 诊断项目状态

1. 检测当前工作目录是否有 `AGENTS.md`
2. 如不存在，询问用户是否执行 `/init` 创建
3. 如存在，统计现有原则数量和名称

**输出示例：**
```
📂 当前目录：/path/to/project

诊断结果：✓ AGENTS.md 已存在（3 个原则）
  - 代码规范
  - Git工作流
  - 测试要求
```

### Step 2: 定位并读取原则库

执行定位脚本获取 `principles.md` 路径：

```bash
python ~/.kimi/skills/add-principles/scripts/locate.py
```

**解析 JSON 输出：**
- `success: true` → 读取 `path` 字段的 `principles.md`，提取所有原则
- `success: false` → 显示错误信息和解决建议

**原则提取规则：**
- 以 `## ` 开头的二级标题为一个原则的标题
- 标题下方直到下一个 `## ` 或文件结束为内容

### Step 3: 展示并选择原则

展示可用原则列表，编号供用户选择：

```
可用原则（来自 principles.md）：
   [1] Session 启动复习原则
   [2] 方案先行与需求澄清
   [3] 任务拆分与文件数量限制
   [4] TODO管理与进度跟踪
   [5] 最小变更原则
   ...（共 N 个）

请选择要添加的原则 [1-N，可多选，空格分隔]：
```

### Step 4: 重复检测（Kimi 语义判断）

对选中的每个原则，执行智能检测：

| 检测维度 | 判断标准 |
|---------|---------|
| **标题匹配** | AGENTS.md 中是否有同名原则 |
| **内容相似度** | Kimi 语义分析内容重叠程度 |

**状态标记：**
- ✅ **无冲突**：可直接添加
- ⚠️ **相似**（内容重叠 > 60%）：询问替换/跳过/合并
- ❌ **重复**（内容重叠 > 90% 或标题完全相同）：自动跳过

**交互示例：**
```
🔍 重复检测结果：

[2] 方案先行与需求澄清
   状态：✅ 无冲突，可直接添加

[3] 任务拆分与文件数量限制
   状态：⚠️ 相似 - 与现有"模块化开发"内容重叠约 65%
   操作选项：
      [r] 替换现有原则
      [k] 保留现有，跳过此原则
      [m] 合并（人工确认差异内容）
   请选择：r

[5] 测试规范
   状态：❌ 已存在（内容相同），自动跳过
```

### Step 5: 生成添加计划

整理成清晰的计划表格：

```
📋 添加计划
════════════════════════════════════════════════════════

目标文件：./AGENTS.md
备份文件：将创建 AGENTS.md.bak.20240223

| 原则 | 操作 | 规则数 | 说明 |
|------|------|--------|------|
| 方案先行与需求澄清 | ➕ 新增 | 5 条 | - |
| 任务拆分与文件数量限制 | 🔄 替换 | 4 条 | 替换"模块化开发" |
| 测试规范 | ⏭️ 跳过 | - | 已存在 |

════════════════════════════════════════════════════════
```

### Step 6: 用户确认

提供选项：

```
请选择：
   [y] 确认执行
   [p] 预览修改后的完整内容
   [e] 编辑（调整原则顺序）
   [n] 返回重新选择
   [q] 取消

> 
```

**各选项处理：**
- **y**: 执行 Step 7
- **p**: 展示预览内容，然后返回此菜单
- **e**: 让用户输入新的顺序（如 `2 1 3`），更新计划后返回此菜单
- **n**: 返回 Step 3 重新选择
- **q**: 结束 Skill，不做任何修改

### Step 7: 执行添加

1. **创建备份**：复制 `AGENTS.md` 为 `AGENTS.md.bak.YYYYMMDD`
2. **按顺序添加**：根据确认的计划，逐个添加/替换原则
3. **格式保持**：
   - 原则之间使用 `---` 分隔
   - 保持原有缩进和列表格式
   - 文件末尾不添加多余空行

**执行示例：**
```
✅ 执行完成
════════════════════════════════════════════════════════

更新摘要：
   新增原则：1 个（方案先行与需求澄清）
   替换原则：1 个（任务拆分与文件数量限制 → 替换"模块化开发"）
   跳过原则：1 个（测试规范 - 已存在）

文件备份：AGENTS.md.bak.20240223
════════════════════════════════════════════════════════
```

## 文件定位说明

`principles.md` 的查找策略（按优先级）：

1. **环境变量**：`ADD_PRINCIPLES_PATH` 指向的路径
2. **Kimi 配置**：`~/.kimi/config.toml` 中的 `skills_dir` 配置
3. **默认路径**：
   - macOS/Linux: `~/.kimi/skills/add-principles/principles.md`
   - Windows: `%USERPROFILE%\.kimi\skills\add-principles\principles.md`
4. **当前目录**：`./add-principles/principles.md`（开发调试场景）

通过 `scripts/locate.py` 脚本实现跨平台定位。

## 边界情况处理

| 情况 | 处理方式 |
|------|---------|
| `principles.md` 不存在 | 显示错误信息，告知可能原因和解决方案 |
| `/init` 执行失败 | 提示初始化失败，建议手动执行 `/init` 后再试 |
| 所有选中原则都已存在 | 提示"所有原则已同步，无需添加" |
| AGENTS.md 写入失败 | 保留备份文件，告知手动操作步骤 |
| 原则内容冲突 | 高亮显示差异，提供替换/保留/合并选项 |
| 用户取消操作 | 不做任何修改，正常退出 |

## 原则库格式规范

`principles.md` 使用二级标题定义原则：

```markdown
## 原则名称

原则详细内容，支持：
- 列表项
- **加粗**
- 多段落

---

## 另一个原则

...
```

**格式要求：**
- 每个原则以 `## ` 二级标题开始
- 原则之间用 `---` 分隔（可选）
- 支持 Markdown 基本语法

## 设计原则

1. **安全第一**：修改前自动备份，失败时保留原文件
2. **用户确认**：执行前展示计划，确认后再写入
3. **智能去重**：语义分析重复，避免冗余添加
4. **跨平台**：支持 macOS、Linux、Windows
5. **可扩展**：通过环境变量支持自定义原则库位置
