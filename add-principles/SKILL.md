---
name: add-principles
description: 向项目 AGENTS.md 添加通用原则的交互式 Skill。自动检测项目状态、智能去重、计划预览。
triggers:
  - 添加原则
  - 增加规范
  - 给项目加原则
  - 同步原则
---

# add-principles Skill

向项目 AGENTS.md 添加通用原则的交互式工具。

## 触发词

- "添加原则"
- "增加规范"
- "给项目加原则"
- "同步原则"

## 执行流程

### Step 1: 诊断项目状态

1. 检测当前工作目录是否有 `AGENTS.md`
2. 如不存在，询问用户是否执行 `/init` 创建
3. 如存在，统计现有原则数量和名称

**输出示例：**
```
📂 当前目录：/path/to/project

诊断结果：✓ AGENTS.md 已存在（3 个原则）
  - 代码规范
  - Git工作流
  - 测试要求
```

### Step 2: 定位并读取原则库

执行定位脚本获取 `principles.md` 路径：

```bash
python ~/.kimi/skills/add-principles/scripts/locate.py
```

**解析 JSON 输出：**
- `success: true` → 读取 `path` 字段的 `principles.md`，提取所有原则
- `success: false` → 显示错误信息和解决建议

**原则提取规则：**
- 以 `## ` 开头的二级标题为一个原则的标题
- 标题下方直到下一个 `## ` 或文件结束为内容

### Step 3: 展示并选择原则

展示可用原则列表，编号供用户选择。平台专用原则会标注标签：

**Windows 平台显示：**
```
可用原则（来自 principles.md）：
   [1] Session 启动复习原则
   [2] 方案先行与需求澄清
   ...
   [15] Windows 命令规范 [当前平台适用]

请选择要添加的原则 [1-15，可多选，空格分隔]：
```

**macOS/Linux 平台显示：**
```
可用原则（来自 principles.md）：
   [1] Session 启动复习原则
   [2] 方案先行与需求澄清
   ...
   [15] Windows 命令规范 [Windows 专用]

请选择要添加的原则 [1-15，可多选，空格分隔]：
```

**平台标签规则：**
- 检测当前操作系统（Windows / macOS / Linux）
- "Windows 命令规范"原则：
  - Windows 平台：显示 `[当前平台适用]`（高亮）
  - 其他平台：显示 `[Windows 专用]`（灰色/弱化）

### Step 4: 重复检测（Kimi 语义判断）

对选中的每个原则，执行智能检测：

| 检测维度 | 判断标准 |
|---------|---------|
| **标题匹配** | AGENTS.md 中是否有同名原则 |
| **内容相似度** | Kimi 语义分析内容重叠程度 |
| **平台匹配** | 平台专用原则与当前平台是否匹配 |

**状态标记：**
- ✅ **无冲突**：可直接添加
- ⚠️ **相似**（内容重叠 > 60%）：询问替换/跳过/合并
- ⚠️ **平台不匹配**：平台专用原则在非目标平台检测到
- ❌ **重复**（内容重叠 > 90% 或标题完全相同）：自动跳过

**交互示例：**
```
🔍 重复检测结果：

[2] 方案先行与需求澄清
   状态：✅ 无冲突，可直接添加

[3] 任务拆分与文件数量限制
   状态：⚠️ 相似 - 与现有"模块化开发"内容重叠约 65%
   操作选项：
      [r] 替换现有原则
      [k] 保留现有，跳过此原则
      [m] 合并（人工确认差异内容）
   请选择：r

[5] 测试规范
   状态：❌ 已存在（内容相同），自动跳过
```

**平台专用原则检测示例（macOS 平台检测到 Windows 原则）：**
```
[15] Windows 命令规范 [Windows 专用]
   状态：⚠️ 平台不匹配 - 当前平台为 macOS
   说明：AGENTS.md 中已存在 Windows 专用原则
   操作选项：
      [k] 保留（可能是在 Windows 上开发的，保持不变）
      [d] 删除（当前平台不适用，建议移除）
      [i] 忽略，保持不变
   请选择：k
```

### Step 5: 生成添加计划

整理成清晰的计划表格：

```
📋 添加计划
════════════════════════════════════════════════════════

目标文件：./AGENTS.md

| 原则 | 操作 | 规则数 | 说明 |
|------|------|--------|------|
| 方案先行与需求澄清 | ➕ 新增 | 5 条 | - |
| 任务拆分与文件数量限制 | 🔄 替换 | 4 条 | 替换"模块化开发" |
| 测试规范 | ⏭️ 跳过 | - | 已存在 |
| Windows 命令规范 | ➕ 新增 | 3 条 | Windows 专用 |

════════════════════════════════════════════════════════
```

### Step 6: 用户确认

提供选项：

```
请选择：
   [y] 确认执行
   [p] 预览修改后的完整内容
   [e] 编辑（调整原则顺序）
   [n] 返回重新选择
   [q] 取消

> 
```

**各选项处理：**
- **y**: 执行 Step 7
- **p**: 展示预览内容，然后返回此菜单
- **e**: 让用户输入新的顺序（如 `2 1 3`），更新计划后返回此菜单
- **n**: 返回 Step 3 重新选择
- **q**: 结束 Skill，不做任何修改

**平台专用原则确认：**
非 Windows 平台用户选择添加"Windows 命令规范"时，前置警告：
```
⚠️ 警告：你选择了"Windows 命令规范"
当前平台：macOS
此原则仅适用于 Windows 平台，确定添加吗？
[y] 确认添加（项目可能在多平台协作）
[n] 取消，返回选择
```

### Step 7: 执行添加

1. **按顺序添加**：根据确认的计划，逐个添加/替换原则
2. **平台专用原则处理**：
   - "Windows 命令规范"写入时，在内容前插入平台警告块
3. **格式保持**：
   - 原则之间使用 `---` 分隔
   - 保持原有缩进和列表格式
   - 文件末尾不添加多余空行

**平台专用原则写入格式示例：**
```markdown
## Windows 命令规范

> ⚠️ **平台限制**：此原则仅适用于 Windows 平台  
> macOS/Linux 开发者请忽略本节

Windows 平台下的命令执行要求：
...
```

**执行示例：**
```
✅ 执行完成
════════════════════════════════════════════════════════

更新摘要：
   新增原则：1 个（方案先行与需求澄清）
   替换原则：1 个（任务拆分与文件数量限制 → 替换"模块化开发"）
   跳过原则：1 个（测试规范 - 已存在）
   新增原则：1 个（Windows 命令规范 - Windows 专用）
════════════════════════════════════════════════════════
```

## 文件定位说明

`principles.md` 的查找策略（按优先级）：

1. **环境变量**：`ADD_PRINCIPLES_PATH` 指向的路径
2. **Kimi 配置**：`~/.kimi/config.toml` 中的 `skills_dir` 配置
3. **默认路径**：
   - macOS/Linux: `~/.kimi/skills/add-principles/principles.md`
   - Windows: `%USERPROFILE%\.kimi\skills\add-principles\principles.md`
4. **当前目录**：`./add-principles/principles.md`（开发调试场景）

通过 `scripts/locate.py` 脚本实现跨平台定位。

## 边界情况处理

| 情况 | 处理方式 |
|------|---------|
| `principles.md` 不存在 | 显示错误信息，告知可能原因和解决方案 |
| `/init` 执行失败 | 提示初始化失败，建议手动执行 `/init` 后再试 |
| 所有选中原则都已存在 | 提示"所有原则已同步，无需添加" |
| AGENTS.md 写入失败 | 告知手动操作步骤 |
| 原则内容冲突 | 高亮显示差异，提供替换/保留/合并选项 |
| 用户取消操作 | 不做任何修改，正常退出 |
| 非 Windows 用户添加 Windows 原则 | 选择时二次确认，提示平台不兼容风险 |
| macOS/Linux 项目含 Windows 原则 | 诊断时标注"检测到 Windows 专用原则"，提供清理选项 |

## 原则库格式规范

`principles.md` 使用二级标题定义原则：

```markdown
## 原则名称

原则详细内容，支持：
- 列表项
- **加粗**
- 多段落

---

## 另一个原则

...
```

**格式要求：**
- 每个原则以 `## ` 二级标题开始
- 原则之间用 `---` 分隔（可选）
- 支持 Markdown 基本语法

## 设计原则

1. **安全第一**：执行前用户确认，避免误操作
2. **用户确认**：执行前展示计划，确认后再写入
3. **智能去重**：语义分析重复，避免冗余添加
4. **跨平台**：支持 macOS、Linux、Windows
5. **可扩展**：通过环境变量支持自定义原则库位置
